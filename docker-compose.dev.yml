services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: elementamon-postgres
    environment:
      POSTGRES_USER: elementamon
      POSTGRES_PASSWORD: elementamon_dev_pass
      POSTGRES_DB: elementamon
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - elementamon-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U elementamon']
      interval: 10s
      timeout: 5s
      retries: 5

  # MongoDB Database
  mongodb:
    image: mongo:7-jammy
    container_name: elementamon-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: elementamon
      MONGO_INITDB_ROOT_PASSWORD: elementamon_dev_pass
      MONGO_INITDB_DATABASE: elementamon
    ports:
      - '27017:27017'
    volumes:
      - mongodb_data:/data/db
    networks:
      - elementamon-network
    healthcheck:
      test: ['CMD', 'mongosh', '--eval', "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: elementamon-redis
    command: redis-server --requirepass elementamon_dev_pass
    ports:
      - '6379:6379'
    volumes:
      - redis_data:/data
    networks:
      - elementamon-network
    healthcheck:
      test: ['CMD', 'redis-cli', '--raw', 'incr', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5

  # Shell App (Host) - Module Federation Host
  shell:
    build:
      context: .
      dockerfile: Dockerfile.angular
      target: shell-dev
    container_name: elementamon-shell
    ports:
      - '4200:4200'
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.nx
    networks:
      - elementamon-network
    environment:
      - NODE_ENV=development
      - NX_DAEMON=false
    depends_on:
      - home
      - deck-builder
      - battle
      - world-map
      - inventory
      - avatar-customization
      - game-over
    restart: unless-stopped

  # Home Remote App
  home:
    build:
      context: .
      dockerfile: Dockerfile.angular
      target: home-dev
    container_name: elementamon-home
    ports:
      - '4201:4201'
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.nx
    networks:
      - elementamon-network
    environment:
      - NODE_ENV=development
      - NX_DAEMON=false
    restart: unless-stopped

  # Deck Builder Remote App
  deck-builder:
    build:
      context: .
      dockerfile: Dockerfile.angular
      target: deck-builder-dev
    container_name: elementamon-deck-builder
    ports:
      - '4202:4202'
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.nx
    networks:
      - elementamon-network
    environment:
      - NODE_ENV=development
      - NX_DAEMON=false
    restart: unless-stopped

  # Battle Remote App
  battle:
    build:
      context: .
      dockerfile: Dockerfile.angular
      target: battle-dev
    container_name: elementamon-battle
    ports:
      - '4203:4203'
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.nx
    networks:
      - elementamon-network
    environment:
      - NODE_ENV=development
      - NX_DAEMON=false
    restart: unless-stopped

  # World Map Remote App
  world-map:
    build:
      context: .
      dockerfile: Dockerfile.angular
      target: world-map-dev
    container_name: elementamon-world-map
    ports:
      - '4204:4204'
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.nx
    networks:
      - elementamon-network
    environment:
      - NODE_ENV=development
      - NX_DAEMON=false
    restart: unless-stopped

  # Inventory Remote App
  inventory:
    build:
      context: .
      dockerfile: Dockerfile.angular
      target: inventory-dev
    container_name: elementamon-inventory
    ports:
      - '4205:4205'
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.nx
    networks:
      - elementamon-network
    environment:
      - NODE_ENV=development
      - NX_DAEMON=false
    restart: unless-stopped

  # Avatar Customization Remote App
  avatar-customization:
    build:
      context: .
      dockerfile: Dockerfile.angular
      target: avatar-customization-dev
    container_name: elementamon-avatar-customization
    ports:
      - '4206:4206'
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.nx
    networks:
      - elementamon-network
    environment:
      - NODE_ENV=development
      - NX_DAEMON=false
    restart: unless-stopped

  # Game Over Remote App
  game-over:
    build:
      context: .
      dockerfile: Dockerfile.angular
      target: game-over-dev
    container_name: elementamon-game-over
    ports:
      - '4207:4207'
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.nx
    networks:
      - elementamon-network
    environment:
      - NODE_ENV=development
      - NX_DAEMON=false
    restart: unless-stopped

  # ========================================
  # Backend Microservices
  # ========================================

  # Auth Service (PostgreSQL)
  auth-service:
    build:
      context: .
      dockerfile: Dockerfile.microservices
      target: auth-service
    container_name: elementamon-auth-service
    ports:
      - '3001:3001'
    volumes:
      - ./services/auth:/app/services/auth
      - /app/node_modules
    networks:
      - elementamon-network
    environment:
      - NODE_ENV=development
      - PORT=3001
      - DATABASE_URL=postgresql://elementamon:elementamon_dev_pass@postgres:5432/elementamon
      - JWT_SECRET=dev_jwt_secret_change_in_production
      - REDIS_URL=redis://:elementamon_dev_pass@redis:6379
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Cards Service (MongoDB)
  cards-service:
    build:
      context: .
      dockerfile: Dockerfile.microservices
      target: cards-service
    container_name: elementamon-cards-service
    ports:
      - '3002:3002'
    volumes:
      - ./services/cards:/app/services/cards
      - /app/node_modules
    networks:
      - elementamon-network
    environment:
      - NODE_ENV=development
      - PORT=3002
      - MONGODB_URI=mongodb://elementamon:elementamon_dev_pass@mongodb:27017/elementamon?authSource=admin
      - REDIS_URL=redis://:elementamon_dev_pass@redis:6379
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Fight Service (MongoDB)
  fight-service:
    build:
      context: .
      dockerfile: Dockerfile.microservices
      target: fight-service
    container_name: elementamon-fight-service
    ports:
      - '3003:3003'
    volumes:
      - ./services/fight:/app/services/fight
      - /app/node_modules
    networks:
      - elementamon-network
    environment:
      - NODE_ENV=development
      - PORT=3003
      - MONGODB_URI=mongodb://elementamon:elementamon_dev_pass@mongodb:27017/elementamon?authSource=admin
      - REDIS_URL=redis://:elementamon_dev_pass@redis:6379
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # World Service (MongoDB)
  world-service:
    build:
      context: .
      dockerfile: Dockerfile.microservices
      target: world-service
    container_name: elementamon-world-service
    ports:
      - '3004:3004'
    volumes:
      - ./services/world:/app/services/world
      - /app/node_modules
    networks:
      - elementamon-network
    environment:
      - NODE_ENV=development
      - PORT=3004
      - MONGODB_URI=mongodb://elementamon:elementamon_dev_pass@mongodb:27017/elementamon?authSource=admin
      - REDIS_URL=redis://:elementamon_dev_pass@redis:6379
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Character Service (MongoDB)
  character-service:
    build:
      context: .
      dockerfile: Dockerfile.microservices
      target: character-service
    container_name: elementamon-character-service
    ports:
      - '3005:3005'
    volumes:
      - ./services/character:/app/services/character
      - /app/node_modules
    networks:
      - elementamon-network
    environment:
      - NODE_ENV=development
      - PORT=3005
      - MONGODB_URI=mongodb://elementamon:elementamon_dev_pass@mongodb:27017/elementamon?authSource=admin
      - REDIS_URL=redis://:elementamon_dev_pass@redis:6379
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Economy Service (MongoDB)
  economy-service:
    build:
      context: .
      dockerfile: Dockerfile.microservices
      target: economy-service
    container_name: elementamon-economy-service
    ports:
      - '3006:3006'
    volumes:
      - ./services/economy:/app/services/economy
      - /app/node_modules
    networks:
      - elementamon-network
    environment:
      - NODE_ENV=development
      - PORT=3006
      - MONGODB_URI=mongodb://elementamon:elementamon_dev_pass@mongodb:27017/elementamon?authSource=admin
      - REDIS_URL=redis://:elementamon_dev_pass@redis:6379
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Skins Service (MongoDB)
  skins-service:
    build:
      context: .
      dockerfile: Dockerfile.microservices
      target: skins-service
    container_name: elementamon-skins-service
    ports:
      - '3007:3007'
    volumes:
      - ./services/skins:/app/services/skins
      - /app/node_modules
    networks:
      - elementamon-network
    environment:
      - NODE_ENV=development
      - PORT=3007
      - MONGODB_URI=mongodb://elementamon:elementamon_dev_pass@mongodb:27017/elementamon?authSource=admin
      - REDIS_URL=redis://:elementamon_dev_pass@redis:6379
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # AI Service (OpenAI, ElevenLabs)
  ai-service:
    build:
      context: .
      dockerfile: Dockerfile.microservices
      target: ai-service
    container_name: elementamon-ai-service
    ports:
      - '3008:3008'
    volumes:
      - ./services/ai:/app/services/ai
      - /app/node_modules
    networks:
      - elementamon-network
    environment:
      - NODE_ENV=development
      - PORT=3008
      - MONGODB_URI=mongodb://elementamon:elementamon_dev_pass@mongodb:27017/elementamon?authSource=admin
      - REDIS_URL=redis://:elementamon_dev_pass@redis:6379
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY:-}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT:-}
      - AZURE_OPENAI_KEY=${AZURE_OPENAI_KEY:-}
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

networks:
  elementamon-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  mongodb_data:
    driver: local
  redis_data:
    driver: local
